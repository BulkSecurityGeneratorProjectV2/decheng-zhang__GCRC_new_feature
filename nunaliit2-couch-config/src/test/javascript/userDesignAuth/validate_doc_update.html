<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<title>userDesignAuth validate_doc_update Test</title>		
		<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.6/themes/base/jquery-ui.css" type="text/css" />
		
		<style type="text/css">
			.error {
				font-weight: strong;
				font-color: #ff0000;
			}
		</style>
	</head>
	<body>

		<h1>userDesignAuth validate_doc_update Test</h1>
		<div id="logs">
		</div>
		
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.6/jquery-ui.min.js"></script>
		<script type="text/javascript" src="../../../main/webapp/WEB-INF/userDesignAuth/validate_doc_update.js"></script>

		<script type="text/javascript">
			// <!--
			
			function printLog(str){
				var $div = $('<div></div>');
				$div.text(str);
				$('#logs').append($div);
			};
			
			function printError(str){
				var $div = $('<div class="error"></div>');
				$div.text('Error: '+str);
				$('#logs').append($div);
			};
			
			var users = {
				john: {
					_id: 'org.couchdb.user:john'
					,_rev: '7-abcedf'
					,name: 'john'
					,roles: []
					,type: 'user'
				}
				,luke: {
					_id: 'org.couchdb.user:luke'
					,_rev: '4-cedfghi'
					,name: 'luke'
					,roles: []
					,type: 'user'
				}
			};
			
			function getUser(opts_){
				var opts = $.extend({
					name: null
					,user: null
					,roles: null
				},opts_);

				if( opts.user ) {
					var u = $.extend(true, {}, opts.user);
				} else if( opts.name ) {
					var template = users[opts.name];
					u = $.extend(true, {}, template);
				} else {
					throw 'user or name must be specified';
				};
				
				if( !u ){
					throw 'user not found';
				};
				
				if( opts.roles ){
					for(var i=0,e=opts.roles.length;i<e;++i){
						u.roles.push( opts.roles[i] );
					};
				};
				
				return u;
			};
			
			function getContext(opts_){
				var opts = $.extend({
					name: null
					,user: null
					,roles: null
				},opts_);

				if( opts.user ) {
					var u = opts.user;
				} else if( opts.name ) {
					u = users[opts.name];
				} else {
					u = {
						name: null
						,roles: []
					};
				};

				var context = {
					name: u.name
					,roles: []
				};
				
				for(var i=0,e=u.roles.length; i<e; ++i){
					context.roles.push(u.roles[i]);
				};
				
				if( opts.roles ){
					for(var i=0,e=opts.roles.length; i<e; ++i){
						context.roles.push(opts.roles[i]);
					};
				};
				
				return context;
			};
			
			var testFunctions = [];
			function defineTest(name, fn){
				testFunctions.push({
					name: name
					,fn: fn
				});
			};
			
			var currentTest = null;
			function startTest(t){
				currentTest = {
					error: null
					,name: t.name
				};
			};
			function fail(e){
				if( currentTest ) {
					currentTest.error = e;
				} else {
					printError('*** Failure without a declared test ***');
				};
			};
			function endTest(){
				currentTest = null;
			};
			
			// *********
			defineTest('_admin can add role to regular user',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['_admin']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
					,roles: ['aRole']
				});
				
				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('_admin can remove role from regular user',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['_admin']
				});

				var userPrev = getUser({
					name: 'luke'
						,roles: ['aRole']
				});

				var userCurrent = getUser({
					name: 'luke'
				});
				
				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('administrator can add role to regular user',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['administrator']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
					,roles: ['aRole']
				});
				
				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('administrator can remove role from regular user',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['administrator']
				});

				var userPrev = getUser({
					name: 'luke'
					,roles: ['aRole']
				});

				var userCurrent = getUser({
					name: 'luke'
				});
				
				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('user creation',function(){

				var userCurrent = getUser({
					name: 'luke'
				});

				validate_doc_update(userCurrent, null, getContext());
			});
			
			// *********
			defineTest('user creation should not include a role',function(){

				var userCurrent = getUser({
					name: 'luke'
					,roles: ['aRole']
				});

				try {
					validate_doc_update(userCurrent, null, getContext());
					fail('Error should be raised');
				} catch(e) {
					// OK
				};
			});
			
			// *********
			defineTest('regular user can modify own document',function(){

				var ctxt = getContext({
					name: 'luke'
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
				});
				userCurrent.display = 'Old Luke';

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('regular user can not add own role',function(){
				var ctxt = getContext({
					name: 'luke'
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
					,roles: ['aRole']
				});

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('error should be raised');
				} catch(e){
					// OK
				};
			});
			
			// *********
			defineTest('regular user can not remove own role',function(){
				var ctxt = getContext({
					name: 'luke'
				});

				var userPrev = getUser({
					name: 'luke'
					,roles: ['aRole']
				});

				var userCurrent = getUser({
					name: 'luke'
				});

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('error should be raised');
				} catch(e){
					// OK
				};
			});
			
			// *********
			defineTest('regular user can not add a role to other',function(){
				var ctxt = getContext({
					name: 'john'
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
					,roles: ['aRole']
				});

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('error should be raised');
				} catch(e){
					// OK
				};
			});
			
			// *********
			defineTest('regular user can not remove a role from other',function(){
				var ctxt = getContext({
					name: 'john'
				});

				var userPrev = getUser({
					name: 'luke'
					,roles: ['aRole']
				});

				var userCurrent = getUser({
					name: 'luke'
				});

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('error should be raised');
				} catch(e){
					// OK
				};
			});
			
			// *********
			defineTest('atlas admin can not add a global role',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['atlas_administrator']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
					,roles: ['vetter']
				});

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('Atlas admin should not be able to add a global role');
				} catch(e) {
					// OK
				}
			});
			
			// *********
			defineTest('atlas admin can not remove a global role',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['atlas_administrator']
				});

				var userPrev = getUser({
					name: 'luke'
					,roles: ['vetter']
				});

				var userCurrent = getUser({
					name: 'luke'
				});

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('Atlas admin should not be able to remove a global role');
				} catch(e) {
					// OK
				}
			});
			
			// *********
			defineTest('atlas admin can add atlas vetter role',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['atlas_administrator']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
					,roles: ['atlas_vetter']
				});

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('atlas admin can remove atlas vetter role',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['atlas_administrator']
				});

				var userPrev = getUser({
					name: 'luke'
					,roles: ['atlas_vetter']
				});

				var userCurrent = getUser({
					name: 'luke'
				});

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('atlas admin can add atlas admin role',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['atlas_administrator']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
					,roles: ['atlas_administrator']
				});

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('atlas admin can remove atlas administrator role',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['atlas_administrator']
				});

				var userPrev = getUser({
					name: 'luke'
					,roles: ['atlas_administrator']
				});

				var userCurrent = getUser({
					name: 'luke'
				});

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('atlas admin can add atlas layer role',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['atlas_administrator']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
					,roles: ['atlas_layer_private']
				});

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('atlas admin can remove atlas layer role',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['atlas_administrator']
				});

				var userPrev = getUser({
					name: 'luke'
					,roles: ['atlas_layer_private']
				});

				var userCurrent = getUser({
					name: 'luke'
				});

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('atlas admin can not add a role for a different atlas',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['atlas_administrator']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userAdmin = getUser({
					name: 'luke'
					,roles: ['other_administrator']
				});

				var userVetter = getUser({
					name: 'luke'
					,roles: ['other_vetter']
				});

				var userLayer = getUser({
					name: 'luke'
					,roles: ['other_layer_private']
				});

				try {
					validate_doc_update(userAdmin, userPrev, ctxt);
					fail('Atlas admin should not be able to add admin role for a different atlas');
				} catch(e) {
					// OK
				}

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('Atlas admin should not be able to add vetter role for a different atlas');
				} catch(e) {
					// OK
				}

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('Atlas admin should not be able to add layer role for a different atlas');
				} catch(e) {
					// OK
				}
			});
			
			// *********
			defineTest('atlas admin can not remove a role for a different atlas',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['atlas_administrator']
				});

				var userPrev = getUser({
					name: 'luke'
					,roles: ['other_vetter']
				});

				var userCurrent = getUser({
					name: 'luke'
				});

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('Atlas admin should not be able to remove a role for a different atlas');
				} catch(e) {
					// OK
				}
			});
			
			// *********
			defineTest('atlas admin can modify content of regular user',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['atlas_administrator']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
				});
				userCurrent.display = 'Display Name';

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('administrator can add atlas administrator',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['administrator']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
					,roles: ['atlas_vetter']
				});

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('administrator can remove atlas administrator',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['administrator']
				});

				var userPrev = getUser({
					name: 'luke'
					,roles: ['atlas_vetter']
				});

				var userCurrent = getUser({
					name: 'luke'
				});

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('can not add a role with underscore',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['administrator']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
					,roles: ['_role']
				});

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('Should not be able to add system role');
				} catch(e) {
					// OK
				};
			});
			
			// *********
			defineTest('can not add a name with underscore',function(){
				var ctxt = null;

				var userPrev = null;

				var userCurrent = getUser({
					user: {
						_id: 'org.couchdb.user:_luke'
						,name: '_luke'
						,roles: []
						,type: 'user'
					}
				});

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('Should not be able to add system user');
				} catch(e) {
					// OK
				};
			});
			
			// *********
			defineTest('can not add a malformed user',function(){
				var ctxt = null;

				var userPrev = null;

				var missingType = getUser({
					user: {
						_id: 'org.couchdb.user:luke'
						,name: 'luke'
						,roles: []
					}
				});

				try {
					validate_doc_update(missingType, userPrev, ctxt);
					fail('Should not be able to add user missing "type" attribute');
				} catch(e) {
					// OK
				};

				var invalidType = getUser({
					user: {
						_id: 'org.couchdb.user:luke'
						,name: 'luke'
						,type: 'invalid'
						,roles: []
					}
				});

				try {
					validate_doc_update(invalidType, userPrev, ctxt);
					fail('Should not be able to add user with invalid "type" attribute');
				} catch(e) {
					// OK
				};

				var missingName = getUser({
					user: {
						_id: 'org.couchdb.user:luke'
						,type: 'user'
						,roles: []
					}
				});

				try {
					validate_doc_update(missingName, userPrev, ctxt);
					fail('Should not be able to add user missing "name" attribute');
				} catch(e) {
					// OK
				};

				var noMatchName = getUser({
					user: {
						_id: 'org.couchdb.user:luke'
						,name: 'john'
						,type: 'user'
						,roles: []
					}
				});

				try {
					validate_doc_update(noMatchName, userPrev, ctxt);
					fail('Should not be able to add user with "name" attribute not matching _id');
				} catch(e) {
					// OK
				};

				var missingId = getUser({
					user: {
						name: 'john'
						,type: 'user'
						,roles: []
					}
				});

				try {
					validate_doc_update(missingId, userPrev, ctxt);
					fail('Should not be able to add user with "_id" attribute missing');
				} catch(e) {
					// OK
				};
			});
			
			// *********
			defineTest('_admin can delete user document',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['_admin']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
				});
				userCurrent._deleted = true;

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('administrator can delete user document',function(){
				var ctxt = getContext({
					name: 'john'
					,roles: ['administrator']
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
				});
				userCurrent._deleted = true;

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('regular user can delete own document',function(){
				var ctxt = getContext({
					name: 'luke'
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
				});
				userCurrent._deleted = true;

				validate_doc_update(userCurrent, userPrev, ctxt);
			});
			
			// *********
			defineTest('regular user can not delete other document',function(){
				var ctxt = getContext({
					name: 'john'
				});

				var userPrev = getUser({
					name: 'luke'
				});

				var userCurrent = getUser({
					name: 'luke'
				});
				userCurrent._deleted = true;

				try {
					validate_doc_update(userCurrent, userPrev, ctxt);
					fail('Regular user is not allowed to delete another document');
				} catch(e) {
					// OK
				};
			});
			
			// *** MAIN ***
			var testsToRun = []; // names of tests to run
			function main_init(){
				printLog('Loaded');
				
				var testCount = 0;
				var testFailure = 0;
				for(var i=0,e=testFunctions.length;i<e;++i){
					var testName = testFunctions[i].name;
					var testFn = testFunctions[i].fn;

					if( testsToRun && testsToRun.length > 0 ){
						if( testsToRun.indexOf(testName) < 0 ){
							continue;
						};
					};
					
					++testCount;
					
					startTest(testFunctions[i]);
					
					try {
						testFn();
					} catch(e) {
						if( e.forbidden ){
							fail(e.forbidden);
						} else {
							fail(e);
						};
					};
					
					if( currentTest.error ){
						++testFailure;
						printError('Failure '+testName+' : '+currentTest.error);
					} else {
						printLog('Successful '+testName);
					};

					endTest(testFunctions[i]);
				};
				
				if( testFailure > 0 ){
					printError('Test count='+testCount+' Failures='+testFailure);
				} else {
					printLog('Test count='+testCount);
				};
			};
			
			jQuery().ready(function() {
				if( typeof(validate_doc_update) === 'function' ) {
					main_init();
				} else {
					alert('In userDesignDoc document, you must rename the validate doc update function to "validate_doc_update" to perform this test.');
				};
			});
			// -->
		</script>
	</body>
</html>
