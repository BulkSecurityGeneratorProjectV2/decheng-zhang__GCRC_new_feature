<!DOCTYPE html>
<html>
  <head>
    <title>Test App</title>
    <link rel="stylesheet" href="../js-external/css/jquery-ui/smoothness/jquery-ui.custom.css" type="text/css">
  </head>
  <body class="nunaliit_application">
    <h1>Test App</h1>

	

    <div id="uuid"> </div>
    <div id="uuid2"> </div>

	<form id="newDoc">
		<span>Title: </span><input type="text" id="title"/><br/>
		<span>Desc: </span><input type="text" id="desc"/><br/>
		<input type="button" id="newDocButton" value="create"/>
	</form>

	<form id="newGeom">
		<span>Geometry: </span><input type="text" id="geomWkt"/><br/>
		<input type="button" id="newGeomButton" value="Create a new Geometry"/>
	</form>
	
	<form id="fetchGeoms">
		<span>MinX: </span><input type="text" id="minX"/><br/>
		<span>MinY: </span><input type="text" id="minY"/><br/>
		<span>MaxX: </span><input type="text" id="maxX"/><br/>
		<span>MaxY: </span><input type="text" id="maxY"/><br/>
		<input type="button" id="fetchGeomsButton" value="Fetch Geometries"/>
	</form>
	<div id="fetchGeomsResult"> </div>
	
	<div id="formManager"> </div>
	
	<h2>Session</h2>
	<div id="currentContext"> </div>
	<div id="login" class="nunaliit_login"> </div>

	<h2>Users</h2>
	<div id="addUser"> </div>
	<div id="allUsers"> </div>
    
  </body>
  <script type="text/javascript" src="../js-external/js/jquery.min.js"></script>
  <script type="text/javascript" src="../js-external/js/jquery-ui.min.js"></script>
  <script type="text/javascript" src="../js-external/js/jquery.form.2.49.js"></script>
  <script type="text/javascript" src="../js-external/OpenLayers/OpenLayers.js"></script>
  <script type="text/javascript" src="../js-external/js/sha1.js"></script>
  <script type="text/javascript" src="../nunaliit2/cometd/json2.js"></script>
  <script type="text/javascript" src="../lib/atlas.js"></script>
  <script type="text/javascript" src="../nunaliit2/nunaliit2-debug.js"></script>
  <script type="text/javascript" src="../nunaliit2/nunaliit2-couch-debug.js"></script>
  
  <script type="text/javascript">

   	var g_session;
    var g_userDb;
   	var g_atlasDb;
    var g_atlasDesign;
	var userSchema;
	var loginSchema;

    function getAllGeometries() {
		$n2.couchGeom.queryGeometries(g_atlasDesign,{
    		onSuccess: function(rows){
				var geoms = [];
				for(var i=0,e=rows.length; i<e; ++i) {
					geoms.push(rows[i].value);
				};
    			reportGeoms(geoms);
	    	}
    	});
    }

	function reportGeoms(geoms) {
		$('#fetchGeomsResult').empty();

		var $t = $('<table></table>');
		
		for(var i=0,e=geoms.length; i<e; ++i) {
			var geom = geoms[i];
			var $r = $('<tr></tr>');
			$t.append($r);
			
			var $d = $('<td>'+geom.nunaliit_geom.wkt+'</td>');
			$r.append($d);
			
			var $d = $('<td><a href="_show/geom/'+geom._id+'">'+geom._id+'</a></td>');
			$r.append($d);
		};
		
		$('#fetchGeomsResult').append($t);
	};
	
	function submitUser(form) {
	
		var user = form.getInputFromName('user').getCurrentValue();
		var display = form.getInputFromName('name').getCurrentValue();

		// Check password
		var pw1 = form.getInputFromName('pw').getCurrentValue();
		var pw2 = form.getInputFromName('pw2').getCurrentValue();
		
		if( pw1 != pw2 ) {
			alert('Password mistmatch');
			return false;
		};
		
		g_userDb.createUser({
			name: user
			,password: pw1
			,display: display
    		,onSuccess: function(docInfo) {
	    		installAddUserButton();
	    		reportAllUsers();
	    	}
    		,onError: alert
		});
		
		// Do not submit
		return false;
	};
	
	function installAddUserButton() {
		var addUserButton = $('<input type="button" value="Add User..."/>');
		addUserButton.click(function(){
			var form = new $n2.form.Form($('#addUser'),{
				schema: userSchema
				,postCancel: installAddUserButton
				,preOK: submitUser
			});
		});
		$('#addUser').empty().append(addUserButton);
	};
	installAddUserButton();

	var loginSchema = new $n2.form.Schema({
		"title": "Login Schema"
		,"okButton": true
		,"okButtonLabel": "Login"
		,"attributes": [
			{
				"name": "username"
				,"type": "text"
				,"label": "User"
				,"description": "The user identifier"
			}
			,{
				"name": "password"
				,"type": "password"
				,"label": "Password"
				,"description": "User's password"
			}
		]
	});
	function loginUser(form) {
	
		var pw = form.getInputFromName('password').getCurrentValue();
		var name = form.getInputFromName('username').getCurrentValue();

		var session = $n2.couch.getSession();

		session.login({
	    	name: name
    		,password: pw
    		,onSuccess: function(info) {
	    		alert('Logged in as: '+info.name);
	    	}
    		,onError: function(error) {
    			alert(error);
	    	}
		});
	
		// Do not submit form
		return false;
	};
	
	function installLogin() {
		var form = new $n2.form.Form($('#login'),{
			schema: loginSchema
			,preOK: loginUser
		});
	};
	
	function reportAllUsers() {
		var $au = $('#allUsers').empty();
		g_userDb.getAllUsers({
			onSuccess: function(allUsers){
				var $t = $('<table><tr><th>Name</th><th>Roles</th></tr></table>');
				for(var i=0,e=allUsers.length; i<e; ++i) {
					var user = allUsers[i];
					var $r = $('<tr></tr>');
					$t.append($r);
					
					$r.append( $('<td>'+user.name+'</td>') );
					$r.append( $('<td>'+user.roles+'</td>') );
					
					var $d = $('<td></td>');
					$r.append($d);
					$d.append( getDeleteButton(user) );
				};
				$au.empty().append($t);
				
				function getDeleteButton(user) {
					user = $.extend({},user,{
						onSuccess: reportAllUsers
						,onError: function(e) { alert(e); }
					});
					
					var b = $('<input type="button" value="Delete"/>');
					b.click(function(){
						g_userDb.deleteUser(user);
					});
					return b;
				}
			}
			,onError: alert
		});
	}
	

	function main() {    
	    g_session.addChangedContextListener(function(context){
    		var $cc = $('#currentContext');
    		$cc.html( '<b>User:</b>'+context.name+' <b>Roles:</b>'+context.roles );
	    	
    		var btn = $('<input type="button" value="Logout"/>');
	    	btn.click(function(){
    			g_session.logout();
    		});
	    	$cc.append(btn);
    	});
    
	    $n2.couch.getUniqueId({
    		onSuccess: function(uuid) {
	    		$('#uuid').text('uuid: '+uuid);
	
		    	$n2.couch.getUniqueId({
			    	onSuccess: function(uuid) {
    					$('#uuid2').text('uuid: '+uuid);
    				}
			    });
    		}
	    });
    
	    $('#newDocButton').click(function(){
    		var title = $('#title').val();
    		var desc = $('#desc').val();
    	
	    	g_atlasDb.createDocument({
    			data: {
    				title: title
	    			,desc: desc
    			}
    			,onSuccess: function(docInfo){
    				$n2.log('docInfo',docInfo);
	    			alert('Created Document!');
    			}
    			,onError: function(errMsg){ $n2.reportError(errMsg); }
    		});
	    });
    
	    $('#newGeomButton').click(function(){
    		var geomWkt = $('#geomWkt').val();

			var doc = {};
			$n2.couchGeom.updateDocumentWithWktGeometry(doc, {
				wkt: geomWkt
			});
	    	g_atlasDb.createDocument({
    			data: doc
	    	});
    	});

	    $('#fetchGeomsButton').click(function(){
    		var minx = $('#minX').val();
    		var miny = $('#minY').val();
	    	var maxx = $('#maxX').val();
    		var maxy = $('#maxY').val();
    		
    		var bounds = null;
    		if( minx != '' && miny != '' && maxx != '' && maxy != '' ) {
    			minx = 1 * minx;
    			miny = 1 * miny;
    			maxx = 1 * maxx;
    			maxy = 1 * maxy;
    			
    			if( maxx != minx && maxy != miny ) {
    				bounds = {
			    		minx: minx
			    		,miny: miny
			    		,maxx: maxx
		    			,maxy: maxy
    				};
    			}
    		}
    		
			$('#fetchGeomsResult').empty();
	
			$n2.couchGeom.queryGeometries(g_atlasDesign,{
		    	bounds: bounds
	    		,onSuccess: function(rows){
					var geoms = [];
					for(var i=0,e=rows.length; i<e; ++i) {
						geoms.push(rows[i].value);
					};
    				reportGeoms(geoms);
		    	}
		 	});
	    });
		
		getAllGeometries();

		userSchema = new $n2.form.Schema({
			"title": "User Schema"
			,"okButton": true
			,"cancelButton": true
			,"resetButton": true
			,"attributes": [
				{
					"name": "user"
					,"type": "text"
					,"label": "Identifier"
					,"description": "The user identifier"
				}
				,{
					"name": "pw"
					,"type": "password"
					,"label": "Password"
					,"description": "User's password"
				}
				,{
					"name": "pw2"
					,"type": "password"
					,"label": "Re-type Password"
					,"description": "User's password verification"
				}
				,{
					"name": "name"
					,"type": "text"
					,"label": "Name"
					,"description": "The name of the user"
				}
			]
		});

		installLogin();
		
		installAddUserButton();

		reportAllUsers();
		
    }
    
    function initAuth() {
		$.NUNALIIT_AUTH.init({
			onSuccess: main
			,autoAnonymousLogin: false
		});
    };
	
    $n2.couch.initialize({
    	pathToServer: '../../../../'
    	,onSuccess: function() {
	    	g_session = $n2.couch.getSession();
		    g_userDb = $n2.couch.getUserDb();
	    	g_atlasDb = $n2.couch.getDb({dbName:'atlas'});
		    g_atlasDesign = g_atlasDb.getDesignDoc({ddName:'atlas'});
		    
		    initAuth();
    	}
    });
	

  </script>
</html>
