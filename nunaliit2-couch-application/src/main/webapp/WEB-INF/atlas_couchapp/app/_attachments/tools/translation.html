<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<title>Translation</title>		
		<link rel="stylesheet" href="../js-external/css/jquery-ui/smoothness/jquery-ui.custom.css" type="text/css" />
		<link rel="stylesheet" href="../js-external/OpenLayers/theme/default/style.css" type="text/css" />
		<link rel="stylesheet" href="../js-external/css/jquery.lightbox-0.5.css" type="text/css" />
		<link rel="stylesheet" href="../nunaliit2/jquery-progress-1.0.css" type="text/css" />
		<link rel="stylesheet" href="../nunaliit2/jquery-progress-slide-1.0.css" type="text/css" />
		<link rel="stylesheet" href="../nunaliit2/css/basic/nunaliit2.css" type="text/css" />
		<link rel="stylesheet" href="../_list/css_merge/css" type="text/css" />
		
	</head>
	<body>

		<h1>Translations</h1>
		<div id="login"></div>
		<div id="requests">
		</div>

		
		<script type="text/javascript" src="../js-external/js/jquery.min.js"></script>
		<script type="text/javascript" src="../js-external/js/jquery-ui.min.js"></script>
		
		<script src="http://maps.google.com/maps/api/js?v=3.3&sensor=false"></script>
		
		<script type="text/javascript" src="../js-external/OpenLayers/OpenLayers.js"></script>
		<script type="text/javascript" src="../js-external/js/jquery.lightbox-0.5.js"></script>
		
		<script type="text/javascript" src="../js-external/js/jquery.cycle.pack.js"></script>
		<script type="text/javascript" src="../js-external/js/jquery.form.js"></script>
		<script type="text/javascript" src="../js-external/js/jquery.cookie-1.0.js"></script>

		<script type="text/javascript" src="../lib/atlas.js"></script>
		<script type="text/javascript" src="../nunaliit2/nunaliit2-debug.js"></script>
		<script type="text/javascript" src="../nunaliit2/nunaliit2-couch-debug.js"></script>
		<script type="text/javascript" src="../config/configuration.js"></script>
		<script type="text/javascript" src="../nunaliit_custom.js"></script>

		<script type="text/javascript">
			// <!--

			var atlasDb = null;
			var atlasDesign = null;
			var currentView = 'l10n-pending';
			
			function selectionChanged() {
				var $select = $(this);
				currentView = $select.val();
				refreshView();
			};
			
			function upload() {
				var $btn = $(this);
				var $tr = $btn.parents('tr');
				
				var json = $tr.find('.json').val();
				var data = JSON.parse(json);
				
				var trans = $tr.find('.trans').val();
				
				data.trans = trans;

				atlasDb.updateDocument({
					data: data
					,onSuccess: refreshView
				});
			};
			
			function showRequests(arr) {
				
				var $table = $('<table></table>');
				$('#requests').empty().append($table);
				
				$table.append('<tr><th>String</th><th>Lang</th><th>Translation</th><th></th><th>Doc ID</th><th>Package</th></tr>');
				
				for(var i=0,e=arr.length; i<e; ++i) {
					var $tr = $('<tr></tr>');
					$table.append($tr);
					
					var row = arr[i];
					var req = row.value;
					
					$tr.append( $('<td>'+req.str+'</td>') );
					$tr.append( $('<td>'+req.lang+'</td>') );
					$tr.append( $('<td><input class="trans" type="text"/></td>') );
					$tr.append( $('<td><input class="uploadBtn" type="button" value="Upload"/></td>') );
					$tr.append( $('<td class="docId">'+req._id+'</td>') );
					$tr.append( $('<td class="packageName">'+req.packageName+'</td>') );
					$tr.append( $('<td><input class="json" type="hidden"/></td>') );
					
					var json = JSON.stringify(req);
					$tr.find('.json').val(json);
					
					if( req.trans ) {
						$tr.find('.trans').val(req.trans);
					};
				};
				
				$table.find('.uploadBtn').click(upload);
			};
			
			function refreshView() {
				// Fetch all pending requests
				atlasDesign.queryView({
					viewName: currentView
					,onSuccess: showRequests
				});
			};
			
			function main() {
				var $select = $('<select><option value="l10n-pending" selected="selected">Pending</option><option value="l10n-all">All</option></select>');
				$('#requests').before($select);
				$select.change(selectionChanged);
				
				refreshView();
			};
			
			function main_init(config) {
				atlasDb = config.atlasDb;
				atlasDesign = config.atlasDesign;

			 	$n2.couchL10n.Configure({
					db: atlasDb
			 		,designDoc: atlasDesign 
			 	});

			 	if( config.directory && config.directory.authService ) {
					config.directory.authService.createAuthWidget({
						elemId: 'login'
					});
				};
			 	
			 	main(atlasDb, atlasDesign);
			};

			jQuery().ready(function() {
				runConfiguration({
					configuredFunction: main_init
					,rootPath: '../'
				});
			});
			// -->
		</script>
	</body>
</html>
