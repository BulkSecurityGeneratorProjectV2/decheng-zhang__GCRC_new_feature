<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head>
		<title>User Management</title>
		
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<title>Translation</title>		
		<link rel="stylesheet" href="../js-external/css/jquery-ui/smoothness/jquery-ui.custom.css" type="text/css" />
		<link rel="stylesheet" href="../js-external/css/jquery.lightbox-0.5.css" type="text/css" />
		<link rel="stylesheet" href="../nunaliit2/css/basic/nunaliit2.css" type="text/css" />
		<link rel="stylesheet" href="../_list/css_merge/css" type="text/css" />
		
	</head>
	<body class="nunaliit_application">

		<h1>User Management</h1>
		<div id="login" class="nunaliit_login"></div>
		<div>
			<input id="btnQueryUsers" type="button" value="Query Users"/>
			<input id="btnAddUser" type="button" value="Add User"/>
		</div>	
		<div id="requests">
		</div>

		
		<script type="text/javascript" src="../js-external/js/jquery.min.js"></script>
		<script type="text/javascript" src="../js-external/js/jquery-ui.min.js"></script>
		
		<script src="http://maps.google.com/maps/api/js?v=3.3&sensor=false"></script>
		
		<script type="text/javascript" src="../js-external/OpenLayers/OpenLayers.js"></script>
		<script type="text/javascript" src="../js-external/js/jquery.lightbox-0.5.js"></script>
		
		<script type="text/javascript" src="../js-external/js/jquery.cycle.pack.js"></script>
		<script type="text/javascript" src="../js-external/js/jquery.form.js"></script>
		<script type="text/javascript" src="../js-external/js/jquery.cookie-1.0.js"></script>
		<script type="text/javascript" src="../js-external/js/sha1.js"></script>

		<script type="text/javascript" src="../lib/atlas.js"></script>
		<script type="text/javascript" src="../nunaliit2/nunaliit2-debug.js"></script>
		<script type="text/javascript" src="../nunaliit2/nunaliit2-couch-debug.js"></script>
		<script type="text/javascript" src="../config/configuration.js"></script>
		<script type="text/javascript" src="../nunaliit_custom.js"></script>

		<script type="text/javascript">
			// <!--

			var userDb = null;

			function reportErrorsOnElem(errors, $elem) {
				$elem.append( $('<div>Error occurred during the request<div>') );
				
				for(var i=0, e=errors.length; i<e; ++i) {
					var e = errors[i];
					if( typeof(e) === 'object' ) {
						e = JSON.stringify(e);
					};
					if( typeof(e) === 'string' ) {
						$elem.append( $('<div>'+e+'<div>') );
					};
				};
			};
			
			function reportError() {
				$('.olkit_wait').remove();
				
				$('#requests').empty();
				reportErrorsOnElem(arguments, $('#requests'));
			};
		
			function startRequestWait() {
				$('#requests').html('<div class="olkit_wait"></div>');
			};
				
			function initiateEdit(userName) {
				// Get document
				startRequestWait();
				userDb.getUser({
					name: userName
					,onSuccess: function(doc) { 
						showEdit(doc); 
					}
					,onError: reportError
				});
				
				function showEdit(doc) {
					$('#requests').empty();
					
					var $editor = $('<div></div>');
					$('#requests').append($editor);
					
					var objectTree = new $n2.tree.ObjectTree($editor,doc);
					var treeEditor = new $n2.tree.ObjectTreeEditor(objectTree,doc);

					var $buttons = $('<div></div>');
					$('#requests').append($buttons);

					var $btnSave = $('<input type="button" value="Save"/>');
					$buttons.append($btnSave);
					var $btnDelete = $('<input type="button" value="Delete"/>');
					$buttons.append($btnDelete);
					
					$btnSave.click(function(){
						$('#editErrors').html('<div class="olkit_wait"></div>');
						userDb.updateUser({
							user: doc
							,onSuccess: function() {
								initiateEdit(userName);
							} 
							,onError: function() {
								$('#editErrors').empty();
								reportErrorsOnElem(arguments, $('#editErrors'));
							}
						});
					});
					
					$btnDelete.click(function(){
						if( false == confirm('You are about delete a user configuration object. Do you wish to proceed?') ) {
							return;
						};
						startRequestWait();
						userDb.deleteUser({
							user: doc
							,onSuccess: function() {
								$('#requests').text('Deleted user for: '+userName);
							} 
							,onError: reportError
						});
					});

					var $password = $('<div></div>');
					$('#requests').append($password);
					$password.append( $('<div>'
						+'<input id="changePw1" type="password"/>'
						+'<input id="changePw2" type="password"/>'
						+'<input id="btnChangePw" type="button" value="Change Password"/>'
						+'</div>') );
					$('#btnChangePw').click(function(){
						var pw1 = $('#changePw1').val();
						var pw2 = $('#changePw2').val();
						
						if( pw1 != pw2 ) {
							alert('Passwords do not match');
						} else if( pw1.length < 6 ) {
							alert('Password is too short');
						} else {
							startRequestWait();
							userDb.setUserPassword({
								user: doc
								,password: pw1
								,onSuccess: function() {
									initiateEdit(userName);
								} 
								,onError: reportError
							});
						};
					});	

					var $errors = $('<div id="editErrors"></div>');
					$('#requests').append($errors);
				};
			};
			
			function addUser() {
				$('#requests').html('<div>'
					+'User Name: <input id="addUserName" type="text"/><br/>'
					+'Password: <input id="addUserPassword1" type="password"/><br/>'
					+'Repeat Password: <input id="addUserPassword2" type="password"/><br/>'
					+'<input id="btnAddUser2" type="button" value="Proceed"/></div>');
				$('#addUserName').focus();
				
				$('#btnAddUser2').click(function(){
					var userName = $('#addUserName').val();
					var pw1 = $('#addUserPassword1').val();
					var pw2 = $('#addUserPassword2').val();

					if( pw1 != pw2 ) {
						alert('Passwords do not match');
					} else if( pw1.length < 6 ) {
						alert('Password is too short');
					} else {
						createInitialUser(userName, pw1);
					}
				});
				
				function createInitialUser(userName, pw) {
					startRequestWait();
					userDb.createUser({
						name: userName
						,password: pw
						,display: userName
						,onSuccess: function() { initiateEdit(userName); }
						,onError: reportError
					});
				};
			};
			
			function queryUsers() {
				startRequestWait();
				
				userDb.getAllUsers({
					onSuccess: reportUsers
					,onError: reportError
				});
				
				function reportUsers(arr) {
					var $table = $('<table></table>');
					$('#requests').empty().append($table);
				
					$table.append('<tr><th>ID</th><th>Revision</th><th>User</th><th>Display</th><th>Roles</th></tr>');
				
					for(var i=0,e=arr.length; i<e; ++i) {
						var $tr = $('<tr></tr>');
						$table.append($tr);
					
						var doc = arr[i];
					
						$tr.append( $('<td class="userId">'+doc._id+'</td>') );
						$tr.append( $('<td class="userRev">'+doc._rev+'</td>') );

						var $td = $('<td class="userName"></td>');
						$tr.append( $td );

						var $a = $('<a href="#" alt="'+doc.name+'">'+doc.name+'</a>');
						$td.append( $a );
						$a.click(function(){
							var $a = $(this);
							var userName = $a.attr('alt');
							initiateEdit(userName);
							return false;
						});

						var display = '';
						if( doc.display ) {
							display = doc.display;
						};
						$tr.append( $('<td class="userDisplay">'+display+'</td>') );
						
						var roles = '';
						if( doc.roles ) {
							roles = doc.roles.join(', ');
						}
						$tr.append( $('<td class="userRoles">'+roles+'</td>') );
					};
				};
			};
			
			function main() {
				$('#btnQueryUsers').click(queryUsers);
				$('#btnAddUser').click(addUser);
			};
			
			function main_init(config) {
				userDb = $n2.couch.getUserDb();
			 	
				if( config.directory && config.directory.authService ) {
					config.directory.authService.createAuthWidget({
						elemId: 'login'
					});
				};

			 	main();
			};

			jQuery().ready(function() {
				runConfiguration({
					configuredFunction: main_init
					,rootPath: '../'
				});
			});
			// -->
		</script>
	</body>
</html>
