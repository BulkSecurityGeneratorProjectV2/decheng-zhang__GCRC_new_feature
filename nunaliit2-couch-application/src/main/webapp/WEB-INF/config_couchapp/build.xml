<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== -->
<project name="config-app" default="default">
	<description>
		CouchApp for Config Database.
	</description>
	
	<!--
		Pick up properties related to when this script is called
		from a WAR file.
	-->
	<property file="../atlas_couchapp/live.properties"/>

	<!-- Local override. -->
	<property file="build.properties"/>
	
	<!-- Configuration -->
	<property name="atlas.name" value="default"/>
	<property name="atlas.config.dir" location="/etc/nunaliit2/couchdb/${atlas.name}"/>
	<property file="${atlas.config.dir}/couch.properties"/>
	<property file="${atlas.config.dir}/install.properties"/>
	
	<property name="config.db.name" value="config"/>
	<property name="config.design.name" value="config"/>
	<property name="config.working.dir" location="./generated"/>
	<property name="couchdb.server.admin" value="http://127.0.0.1:5984"/>
	
	<!-- ================================= -->
	<target
		name="default"
		depends="couchAppPush"
		description="Generate and deploy application"
		>
	
	</target>

	<target
		name="clean"
		description="Clean all generated files"
		>
		
		<delete dir="${config.working.dir}" failonerror="false"/>
	
	</target>
	
	<!-- ================================= -->
	<target
		name="couchAppPush"
		depends="staging"
		description="Deploy a couchApp"
		>
		
		<mkdir dir="${config.working.dir}"/>
		
		<exec
			executable="couchapp"
			dir="${config.working.dir}"
			>
			<arg line="push ${config.design.name} ${couchdb.server.admin}/${config.db.name}"/>
		</exec>
	
	</target>

	<!-- ================================= -->
	<target
		name="staging"
		depends="couchAppGenerate,javascript-copy,appCopy"
		description="Generate application staging"
		>

	</target>

	<!-- ================================= -->
	<target
		name="couchAppGenerate"
		depends="couchapp-conditions"
		unless="project.exists"
		description="Generate a new couchApp"
		>
		
		<mkdir dir="${config.working.dir}"/>
		
		<exec
			executable="couchapp"
			dir="${config.working.dir}"
			>
			<arg line="generate ${config.design.name}"/>
		</exec>
	
	</target>

	<target name="couchapp-conditions">
		<available file="${config.working.dir}/${config.design.name}/_id" property="project.exists"/>
	</target>
	
	<!-- ================================= -->
	<target
		name="javascript-copy"
		description="Copy javascript library files"
		>

		<ant
			dir="../atlas_couchapp"
			target="javascript-copy"
			>
			<property name="javascript.dest.dir" location="${config.working.dir}/${config.design.name}/_attachments"/>
		</ant>
	</target>
	
	<!-- ================================= -->
	<target
		name="appCopy"
		description="Copy application files"
		>
		
		<copy todir="${config.working.dir}/${config.design.name}">
			<fileset dir="./app"/>
		</copy>
	
	</target>
	
</project>
