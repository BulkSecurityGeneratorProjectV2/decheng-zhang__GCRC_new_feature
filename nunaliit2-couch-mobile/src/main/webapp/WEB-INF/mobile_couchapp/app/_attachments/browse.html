<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<title>Data Browser</title>

		<link rel="stylesheet" href="js-external/css/jquery-ui/smoothness/jquery-ui.custom.css" type="text/css" />
		<link rel="stylesheet" href="nunaliit2/css/basic/nunaliit2.css" type="text/css" />
		
		<style type="text/css">
			.n2CouchEditor_schema {
				height: 400px;
			}
			
			#requests {
				font-family: Verdana,Arial,sans-serif;
    			font-size: 1.1em;
			}
		</style>
	</head>
	<body style="overflow: auto;">

		<div id="menu">
			<!-- input id="searchText" type="text"/>
			<input id="searchButton" type="button" value="Search"/>
			<input id="listAllButton" type="button" value="List All Documents"/>
			<input id="addDocumentButton" type="button" value="New Document"/  -->
			<!--  input id="addPic" type="button" value="Add Picture"/ -->
		</div>
		<div id="requests">
		</div>
		
		<script type="text/javascript" charset="utf-8" src="phonegap-1.0.0.js"></script>
		<script type="text/javascript" charset="utf-8" src="config.js"></script>
		<script type="text/javascript" charset="utf-8" src="js-external/js/jquery.min.js"></script>
		<script type="text/javascript" charset="utf-8" src="js-external/js/jquery-ui.min.js"></script>
		<script type="text/javascript" src="lib/utils.js"></script>
		<script type="text/javascript" charset="utf-8" src="nunaliit2/nunaliit2-couch-mobile.js"></script>
		
		<script type="text/javascript">
			// <!--

			var DEBUGGING = true;
			
			var mobileDb = null;
			var mobileDesign = null;
			var uploadServer = null;
			var couchEditor = null;
			var defaultSchema = null;
			var searchServer = null;

			var viewUpdateIssueIsFixed = false;
			
			function reportErrorsOnElem(errors, $elem) {
				$elem.append( $('<div>Error occurred during the request<div>') );
				
				for(var i=0, e=errors.length; i<e; ++i) {
					var e = errors[i];
					if( typeof(e) === 'object' ) {
						e = JSON.stringify(e);
					};
					if( typeof(e) === 'string' ) {
						$elem.append( $('<div>'+e+'<div>') );
					};
				};
			};
			
			function reportError() {
				$('.olkit_wait').remove();
				
				$('#requests').empty();
				reportErrorsOnElem(arguments, $('#requests'));
			};
		
			function startRequestWait() {
				$('#requests').html('<div class="olkit_wait"></div>');
			};
				
			function initiateEdit(docId) {
				// Get document
				startRequestWait();
				mobileDb.getDocument({
					docId: docId
					,onSuccess: function(doc) {
						var schemaName = doc.nunaliit_schema;
						if( !schemaName ) {
							showEdit(doc); 
						} else {
							$n2.schema.DefaultRepository.getSchema({
								name: schemaName
								,onSuccess: function(schema){
									showEdit(doc,schema);
								}
								,onError: function(){
									showEdit(doc);
								}
							});
						};
					}
					,onError: reportError
				});
				
				function showEdit(doc,schema) {
					$('#requests').empty();
					
					// Cancel previous editors
					couchEditor.cancelDocumentForm();
					
					// Couch Editor
					var couchEditorId = $n2.getUniqueId();
					var $couchEditorDiv = $('<div id="'+couchEditorId+'" class="couchEditorDiv"></div>');
					$('#requests').append( $couchEditorDiv );
					
					couchEditor.showDocumentForm(doc,{
						panelName: couchEditorId
						,schema: schema
					});

					// References to other objects
					$('#requests').append( $('<h3>Other documents referenced by this document</h3>') );
					var references = [];
					n2utils.extractLinks(doc, references);
					var $table = $('<table></table>');
					$('#requests').append($table);
					for(var i=0,e=references.length; i<e; ++i) {
						var docId = references[i].doc;
						var $tr = $('<tr></tr>');

						$table.append($tr);

						var $td = $('<td class="docId"></td>');
						$tr.append( $td );

						var $a = $('<a href="#'+docId+'" alt="'+docId+'">'+docId+'</a>');
						$td.append( $a );
						$a.click(function(){
							var $a = $(this);
							var docId = $a.attr('alt');
							initiateEdit(docId);
							return true;
						});

						var $td = $('<td class="brief"></td>');
						$tr.append( $td );
						loadBrief($td,docId);
					};

					// References from other objects
					$('#requests').append( $('<h3>Other documents referencing this document</h3>') );
					$('#requests').append( $('<div id="referencesToThis"><div class="olkit_wait"></div></div>') );
					mobileDesign.queryView({
						viewName: 'link-references'
						,startkey: doc._id
						,endkey: doc._id
						,onSuccess: function(rows) { 
							var $table = $('<table></table>');
							$('#referencesToThis').empty().append($table);
							for(var i=0,e=rows.length; i<e; ++i) {
								var docId = rows[i].id;
								var $tr = $('<tr></tr>');

								$table.append($tr);

								var $td = $('<td class="docId"></td>');
								$tr.append( $td );

								var $a = $('<a href="#'+docId+'" alt="'+docId+'">'+docId+'</a>');
								$td.append( $a );
								$a.click(function(){
									var $a = $(this);
									var docId = $a.attr('alt');
									initiateEdit(docId);
									return true;
								});

								var $td = $('<td class="brief">'+docId+'</td>');
								$tr.append( $td );
								loadBrief($td,docId);
							};
						}
						,onError: reportError
					});

					// Attachments
					if( doc._attachments ) {
						$('#requests').append( $('<h3>Attachments</h3>') );
						var $table = $('<table></table>');
						$('#requests').append($table);
						for(var key in doc._attachments) {
							var att = doc._attachments[key];
							var $tr = $('<tr></tr>');
	
							$table.append($tr);
	
							var $td = $('<td class="attachment"></td>');
							$tr.append( $td );
	
							var attUrl = mobileDb.getDocumentUrl(doc);
							attUrl = attUrl + '/' + key;
							var $a = $('<a href="'+attUrl+'">'+key+'</a>');
							$td.append( $a );
							$a.click(clickShowAttachment);

							var type = '';
							if( att.content_type ) {
								type = att.content_type;
							};
							var $td = $('<td class="type">'+type+'</td>');
							$tr.append( $td );

							var size = '';
							if( att.length ) {
								size = att.length;
							};
							var $td = $('<td class="type">'+size+'</td>');
							$tr.append( $td );
						};
					};

					var $errors = $('<div id="editErrors"></div>');
					$('#requests').append($errors);
					
				};
			};

			function clickShowAttachment(){
				var $a = $(this);
				var src = $a.attr('href');
				$a.before( $('<img src="'+src+'"/>') );
				$a.remove();
				return false;
			};
			
			// This function is needed because the views on
			// mobile couchbase do not update and the default
			// schema handler get out of whack
			function reloadAllSchemas(opts_) {
				var opts = $n2.extend({
					db: mobileDb
					,onSuccess: function(){}
					,onError: function(err){}
				},opts_);

				// Log progress
				$('#logs').remove();
				$('#requests').before( $('<div id="logs"></div>') );
				$('#logs').append('<div>Get all document ids</div>');
				
				// Get a list of all documents, discounting
				// special documents
				opts.db.listAllDocuments({
					onSuccess: function(docIds){
						var ids = [];
						for(var i=0,e=docIds.length; i<e; ++i) {
							var docId = docIds[i];
							if( docId[0] != '_' ) {
								ids.push(docId);
							};
						};
						getDocs(ids);
					}
					,onError: onError
				});
			
				// Get content of all documents, selecting those that are
				// schemas
				function getDocs(ids) {
					$('#logs').append('<div>Get all documents ('+ids.length+')</div>');
					opts.db.getDocuments({
						docIds: ids
						,onSuccess: function(docs){
							var schemas = [];
							for(var i=0,e=docs.length; i<e; ++i) {
								var doc = docs[i];
								if( doc.nunaliit_type === 'schema' ) {
									schemas.push(doc);
								};
							};
							restoreDefaultSchemaRepository(schemas);
						}
						,onError: onError
					});
				};
				
				// Create a new repository containing the schemas, and
				// install it as default repository
				function restoreDefaultSchemaRepository(schemaDefs) {
					$('#logs').append('<div>Install new repository ('+schemaDefs.length+')</div>');
					var schemaRepository = new $n2.schema.SchemaRepository();
					$n2.schema.DefaultRepository = schemaRepository;
					schemaRepository.addSchemas({
						schemas: schemaDefs
						,onSuccess: onSuccess
						,onError: onError
					});
				};
				
				function onSuccess() {
					$('#logs').remove();
					opts.onSuccess();
				};
				
				function onError(err) {
					$('#logs').append('<div>Error: '+err+'</div>');
					opts.onError(err);
				};
			};
			
			// This function is needed because the views on
			// mobile couchbase do not update
			function getRootSchemas(opts_) {
				var opts = $n2.extend({
					onSuccess: function(schemas){}
					,onError: function(err){}
				},opts_);
				
				if( viewUpdateIssueIsFixed ) {
					// This is the piece of code that works when the views
					// do.
					$n2.schema.DefaultRepository.getRootSchemas({
						onSuccess: function(schemas){
							opts.onSuccess(schemas);
						}
						,onError: opts.onError
					});
					
				} else {
					
					// Special code for goign around views
					reloadAllSchemas({
						onSuccess: fetchRootSchemas
						,onError: opts.onError
					});
				};

				// Fetch all root documents from newly installed
				// repository
				function fetchRootSchemas() {
					$n2.schema.DefaultRepository.getRootSchemas({
						onSuccess: function(schemas){
							opts.onSuccess(schemas);
						}
						,onError: opts.onError
					});
				};
			};
			
			function addDocument() {
				getRootSchemas({
					onSuccess: function(schemas){
						selectNewDocumentSchema(schemas);
					}
					,onError: function(){
						createNewDocument({});
					}
				});
			};
			
			function listAllDocuments() {
				mobileDb.listAllDocuments({
					onSuccess: listDocIds
					,onError: function(err){
						reportError('Unable to list all documents: '+err);
					}
				});
				
				function listDocIds(docIds) {
					var $table = $('<table></table>');
					$('#requests').empty().append($table);
				
					$table.append('<tr><th>ID</th></tr>');

					for(var i=0,e=docIds.length; i<e; ++i) {
						var docId = docIds[i];
						var $tr = $('<tr></tr>');

						$table.append($tr);

						var $td = $('<td class="docId"></td>');
						$tr.append( $td );

						var $a = $('<a href="#'+docId+'" alt="'+docId+'">'+docId+'</a>');
						$td.append( $a );
						$a.click(function(){
							var $a = $(this);
							var docId = $a.attr('alt');
							initiateEdit(docId);
							return true;
						});
					
						$td = $('<td></td>');
						$tr.append($td);
						loadBrief($td,docId)
					};
				};
			};
			
			function selectNewDocumentSchema(schemas) {
				
				var uniqueId = $n2.getUniqueId();
				var $dialog = $('<div id="'+uniqueId+'"><table>'
					+'<tr><th>Schema</th><td><select></select></td></tr>'
					+'<tr><td></td><td><button>OK</button><button>Cancel</button></td></tr>'
					+'</table></div>');
				
				var $select = $dialog.find('select');
				for(var i=0,e=schemas.length; i<e; ++i) {
					var $option = $('<option></option>');
					$option.text(''+schemas[i].name);
					$select.append( $option );
				};
				
				var $buttons = $dialog.find('button');
				$buttons.first()
					.button({icons:{primary:'ui-icon-check'}})
					.click(function(){
						var $dialog = $('#'+uniqueId);
						var $select = $dialog.find('select');
						var schemaName = $select.val();

						$n2.log('schemaName',schemaName);
						$n2.schema.DefaultRepository.getSchema({
							name: schemaName
							,onSuccess: function(schema){
								var obj = schema.createObject({});
								createNewDocument(obj,schema);
							}
							,onError: function(err){
								reportError('Unable to get selected schema: '+err);
							}
						});
						
						$dialog.dialog('close');
					});
				$buttons.first().next()
					.button({icons:{primary:'ui-icon-cancel'}})
					.click(function(){
						var $dialog = $('#'+uniqueId);
						$dialog.dialog('close');
					});
				
				$dialog.dialog({
					autoOpen: true
					,title: 'Select Document Schema'
					,modal: true
					,close: function(event, ui){
						var diag = $(event.target);
						diag.dialog('destroy');
						diag.remove();
					}
				});
			};
			
			function createNewDocument(doc,schema) {

				$n2.couchMap.adjustDocument(doc);
				
				showEdit(doc,schema);
				
				function showEdit(doc,schema) {
					$('#requests').empty();
					
					// Cancel previous editors
					couchEditor.cancelDocumentForm();
					
					var $editor = $('<div></div>');
					$('#requests').append($editor);

					couchEditor.showDocumentForm(doc,{
						panelName: 'requests'
						,schema: schema
					});
					$n2.log('schema',schema);
					$n2.log('couchEditor',couchEditor);

					var $errors = $('<div id="editErrors"></div>');
					$('#requests').append($errors);
				};
			};
			
			function performSearch() {
				startRequestWait();

				var searchLine = $('#searchText').val();
				var searchRequest = new $n2.couchSearch.SearchRequest(searchLine, {
					designDoc: mobileDesign
					,db: mobileDb
					,onlyFinalResults: true
					,onSuccess: displayResults
					,onError: function(err){ 
						reportError('Invalid search results returned'); 
					}
				});
				
				function displayResults(searchResults) {
					var sorted = searchResults.sorted;
					
					if( sorted.length < 1 ) {
						$('#requests').html('<div>Search returned empty.</div>');
						return;
					};

					var $table = $('<table></table>');
					$('#requests').empty().append($table);
					
					for(var i=0,e=sorted.length; i<e; ++i) {
						var doc = sorted[i].doc;

						var $tr = $('<tr></tr>');

						$table.append($tr);

						var $td = $('<td class="docId"></td>');
						$tr.append( $td );

						var $a = $('<a href="#'+doc._id+'" alt="'+doc._id+'">'+doc._id+'</a>');
						$td.append( $a );
						$a.click(function(){
							var $a = $(this);
							var docId = $a.attr('alt');
							initiateEdit(docId);
							return true;
						});
					
						$tr.append( $('<td class="docRev">'+doc._rev+'</td>') );
						
						$td = $('<td></td>');
						$tr.append($td);
						displayBrief($td,doc);
					};
				};
			};
			
			// Called to load brief description for a docId
			function loadBrief($td,docId) {
				mobileDb.getDocument({
					docId: docId
					,onSuccess: function(doc) {
						displayBrief($td,doc);
					}
					,onError: function(){
						$td.text('Not loading');
					}
				});
			};
			
			// Given a document, display a brief description
			// of it in the given element
			function displayBrief($td,doc) {
				if( doc.nunaliit_schema ) {
					$n2.schema.DefaultRepository.getSchema({
						name: doc.nunaliit_schema
						,onSuccess: function(schema) {
							schema.brief(doc,$td);
						}
						,onError: function(){
							if( defaultSchema ) {
								defaultSchema.brief(doc,$td);
							} else {
								$td.text('Associated schema not loading');
							};
						}
					});
					
				} else if( defaultSchema ) {
					defaultSchema.brief(doc,$td);
					
				} else {
					$td.text('No associated schema');
				};
			};
			
			function showDebugging() {
				$('#requests').empty();
				$('#requests').html(
					'<div id="debugButtons">'
					+'<button id="debugIdentityView">Identity View</button>'
					+'<button id="debugTextSearchView">Text Search View</button>'
					+'<button id="debugUpdateTest">Update Tests</button>'
					+'</div>'
					+'<div id="debugOutput"></div>'
				);
				
				$('#requests').find('#debugIdentityView')
					.click(function(e){
						$('#debugOutput').text('Wait...');
						mobileDesign.queryView({
							viewName: 'identity'
							,onSuccess: function(rows) { 
								var $table = $('<table></table>');
								$('#debugOutput').empty().append($table);
								for(var i=0,e=rows.length; i<e; ++i) {
									var docId = rows[i].id;
									var $tr = $('<tr></tr>');

									$table.append($tr);

									var $td = $('<td class="docId">'+docId+'</td>');
									$tr.append( $td );
								};
							}
							,onError: function(err){
								$('#debugOutput').text('Error: '+err);
							}
						});
					});
				
				$('#requests').find('#debugTextSearchView')
					.click(function(e){
						$('#debugOutput').text('Wait...');
						mobileDesign.queryView({
							viewName: 'text-search'
							,limit: 10
							,onSuccess: function(rows) { 
								var $table = $('<table></table>');
								$('#debugOutput').empty().append($table);
								for(var i=0,e=rows.length; i<e; ++i) {
									var docId = rows[i].id;
									var key = rows[i].key;
									var $tr = $('<tr></tr>');

									$table.append($tr);

									var $td = $('<td class="docId">'+docId+'</td>');
									$tr.append( $td );

									var jsonKey = JSON.stringify(key);
									var $td = $('<td class="key">'+jsonKey+'</td>');
									$tr.append( $td );
								};
							}
							,onError: function(err){
								$('#debugOutput').text('Error: '+err);
							}
						});
					});
				
				$('#requests').find('#debugUpdateTest')
					.click(debugUpdateTest);
			};
			
			// DEBUG UPDATE TEST
			function debugUpdateTest(){
				
				var docId1 = null;
				var docId2 = null;
				
				$('#debugOutput').empty();
				
				createDoc1();
				
				function createDoc1() {
					debugLog('Creating document 1');
					mobileDb.createDocument({
						data: {
							generic:{
								description: ''
								,reference: {
									doc: ''
									,nunaliit_type: 'reference'
								}
								,title: 'Interal Test Doc 1'
							}
							,nunaliit_created: {
								action: 'created'
								,name: 'admin'
								,nunaliit_type: 'actionstamp'
								,time: 1313684610751
							}
							,nunaliit_last_updated: {
								action: 'updated'
								,name: 'admin'
								,nunaliit_type: 'actionstamp'
								,time: 1313684610751
							}
							,nunaliit_schema: 'genericDoc'
							,nunaliit_type: 'genericDoc'
						}
						,onSuccess: function(docInfo) {
							docId1 = docInfo.id;
							debugLog('Document 1: '+docId1);
							queryIdentities1();
						}
						,onError: fail
					});
				};
				
				function queryIdentities1() {
					debugLog('Querying Identities');
					mobileDesign.queryView({
						viewName: 'identity'
						,onSuccess: function(rows) {
							var ids = {};
							for(var i=0,e=rows.length; i<e; ++i) {
								var docId = rows[i].id;
								ids[docId] = true;
								debugLog('Id: '+docId);
							};
							
							if( !ids[docId1] ) {
								debugLog('Error: id for document 1 not reported');
								fail();
							} else {
								createDoc2();
							};
						}
						,onError: fail
					});
				};
				
				function createDoc2() {
					debugLog('Creating document 2');
					mobileDb.createDocument({
						data: {
							name: 'just another test'
						}
						,onSuccess: function(docInfo) {
							$n2.log('docInfo',docInfo);
							docId2 = docInfo.id;
							debugLog('Document 2: '+docId2);
							queryIdentities2();
						}
						,onError: fail
					});
				};
				
				function queryIdentities2() {
					debugLog('Querying Identities');
					mobileDesign.queryView({
						viewName: 'identity'
						,onSuccess: function(rows) {
							var ids = {};
							for(var i=0,e=rows.length; i<e; ++i) {
								var docId = rows[i].id;
								ids[docId] = true;
								debugLog('Id: '+docId);
							};
							
							if( !ids[docId1] ) {
								debugLog('Error: id for document 1 not reported');
								fail();
							} else if( !ids[docId2] ) {
								debugLog('Error: id for document 2 not reported');
								fail();
							} else {
								debugLog('Tests completed successfully');
							};
						}
						,onError: fail
					});
				};
				
				function fail() {
					debugLog('Error: Test case failures');
				};
				
				function debugLog(str) {
					$('#debugOutput').append('<div>'+str+'</div>');
				};
			};
			// DEBUG UPDATE TEST
			
			function gpsImplementation() {
				if( typeof(imports) !== 'undefined'
				 && imports.navigator
				 && imports.navigator.geolocation 
				 && imports.navigator.geolocation.getCurrentPosition ) {
					return imports.navigator.geolocation;
					
				} else if( typeof(navigator) !== 'undefined' 
				 && navigator.geolocation 
				 && navigator.geolocation.getCurrentPosition ) {
					return navigator.geolocation;
				};
				
				return null;
			};

			function gpsInsertPositionInDocument(editedDocument, editor) {
				
				var myGeolocation = gpsImplementation();
				var uniqueId = $n2.getUniqueId();
				
				showWait();
				getPosition();
				
				function showWait() {
					var $dialog = $('<div id="'+uniqueId+'">'
						+'<div class="olkit_wait"></div>'
						+'</div>');
					
					$dialog.dialog({
						autoOpen: true
						,title: 'Querying GPS'
						,modal: true
						,close: function(event, ui){
							var diag = $(event.target);
							diag.dialog('destroy');
							diag.remove();
						}
					});
				};
				
				function getPosition() {
					myGeolocation.getCurrentPosition(
						onGpsSuccess
						,onGpsError
						,{
						}
					);
				};
					
				function onGpsSuccess(pos) {
					$('#'+uniqueId).dialog('close');
					var lat = pos.coords.latitude;
					var lon = pos.coords.longitude;
					editedDocument.nunaliit_geom = {
						nunaliit_type: 'geometry'
						,wkt:'MULTIPOINT(('+lon+' '+lat+'))'
						,bbox:[lon,lat,lon,lat]
					};
					editor.refresh();
				};
				
				function onGpsError(message) {
					var $dialog = $('#'+uniqueId);
					$dialog.html('<div>Error encountered while querying GPS: '+message+'</div>'
						+'<button>Dismiss</button>');
					$dialog.find('button')
						.button({icons:{primary:'ui-icon-cancel'}})
						.click(function(){ 
							$dialog.dialog('close');
						});
				};
			}; // gpsInsertPositionInDocument
			
			function cameraIsAvailable() {
				if( typeof(imports) !== 'undefined'
				 && imports.navigator
				 && imports.navigator.camera
				 && imports.navigator.camera.getPicture
				 ) {
					return true;
				};
				
				return false;
			};
			
			function cameraInsertImageDataInDocument(editedDocument, editor) {
				
				selectSource();
				
				function selectSource() {
					var uniqueId = $n2.getUniqueId();
					var $dialog = $('<div id="'+uniqueId+'">'
						+'<div><button class="cameraPicture">Take Picture using Camera</button></div>'
						+'<div><button class="cameraLibrary">Select Picture from Library</button></div>'
						+'<div><button class="cameraCancel">Cancel</button></div>'
						+'</div>');
					
					$dialog.find('.cameraPicture')
						.button({icons:{primary:'ui-icon-image'}})
						.click(function(){ 
							$dialog.dialog('close');
							takePhoto(1); 
						}); // CAMERA
						
					$dialog.find('.cameraLibrary')
						.button({icons:{primary:'ui-icon-search'}})
						.click(function(){ 
							$dialog.dialog('close');
							takePhoto(0); 
						}); // PHOTOLIBRARY
						
					$dialog.find('.cameraCancel')
						.button({icons:{primary:'ui-icon-cancel'}})
						.click(function(){ 
							$dialog.dialog('close');
						});

					$dialog.dialog({
						autoOpen: true
						,title: 'Select Photo Source'
						,modal: true
						,close: function(event, ui){
							var diag = $(event.target);
							diag.dialog('destroy');
							diag.remove();
						}
					});
				};
				
				function takePhoto(sourceType) {
					imports.navigator.camera.getPicture(onCameraSuccess, onCameraError, {
						quality: 50
						,destinationType: 0 // DATA_URL
						,sourceType: sourceType
					});
				};

				function onCameraSuccess(imageData) {
                    var message = {
                    	mimeType: 'image/jpeg'
                    	,data: imageData
                    };
                    captureMetaData(message);
	            };
	                               
	            function onCameraError(message) {
	            	alert('Error taking picture: '+errMessage);
	            };
				
				function captureMetaData(imageData) {
					var uniqueId = $n2.getUniqueId();
					var $dialog = $('<div id="'+uniqueId+'"><table style="width:100%">'
						+'<tr><th>Title</th><td><input type="text" style="width:100%"/></td></tr>'
						+'<tr><th>Description</th><td><textarea style="width:100%"></textarea></td></tr>'
						+'<tr><td></td><td><button>OK</button><button>Cancel</button></td></tr>'
						+'</table></div>');
					
					var $buttons = $dialog.find('button');
					$buttons.first()
						.button({icons:{primary:'ui-icon-check'}})
						.click(function(){
							var $dialog = $('#'+uniqueId);
							var title = $dialog.find('input:text').val();
							var description = $dialog.find('textarea').val();
							
							performImageInsert(title, description, imageData, editedDocument, editor);
							
							$dialog.dialog('close');
						});
					$buttons.first().next()
						.button({icons:{primary:'ui-icon-cancel'}})
						.click(function(){
							var $dialog = $('#'+uniqueId);
							$dialog.dialog('close');
						});
					
					$dialog.dialog({
						autoOpen: true
						,title: 'Enter file details'
						,modal: true
						,width: 400
						,close: function(event, ui){
							var diag = $(event.target);
							diag.dialog('destroy');
							diag.remove();
						}
					});
				};
				
				function performImageInsert(
					title
					,description
					,imageData
					,editedDocument
					,editor
					) {
				
					if( !editedDocument._attachments ) {
						editedDocument._attachments = {};
					};
					
					// Look for a new name
					var counter = 0;
					var prefix = 'image_';
					var attName = prefix+counter;
					while( editedDocument._attachments
					 && editedDocument._attachments[attName] ) {
						++counter;
						attName = prefix+counter;
					};
					
					editedDocument._attachments[attName] = {
						content_type: imageData.mimeType
						,data: imageData.data
					};
					
					if( !editedDocument.nunaliit_attachments ) {
						editedDocument.nunaliit_attachments = {
							nunaliit_type: 'attachment_descriptions'
						};
					};
					if( !editedDocument.nunaliit_attachments.files ) {
						editedDocument.nunaliit_attachments.files = {};
					};
					
					editedDocument.nunaliit_attachments.files[attName] = {
						attachmentName: attName
						,fileClass: 'image'
						,status: 'attached'
						,conversionPerformed: false
						,originalName: attName
						,mimeType: imageData.mimeType
						,mobileSource: true
						,data: {
							title: title
							,description: description
						}
					};
					
					editor.refresh();
				};
			}; // cameraInsertImageDataInDocument
			
			function main_init(config) {
				$n2.log('main_init',config);
				mobileDb = config.mobileDb;
				mobileDesign = config.mobileDesign;
				uploadServer = config.uploadServer;
				searchServer = config.searchServer;
			 	
				$n2.schema.DefaultRepository.getSchema({
					name: 'object'
					,onSuccess: function(schema) {
						defaultSchema = schema;
						setUpEditor();
					}
					,onError: function(err) {
						$n2.log('Unable to load schema for editor',err);
						setUpEditor();
					}
				});
				
				function setUpEditor() {
					// Editor
					var editorOptions = {
						db: mobileDb
						,uploadServer: uploadServer
						,searchServer: searchServer
						,schema: defaultSchema
						,onCloseFn: function(){
							$('#requests').empty();
						}
					};
					if( null != gpsImplementation() ) {
						editorOptions.buttonGPS = {
							buttonClass: 'gps'
							,label: 'GPS'
							,before: 'cancel'
							,options: {icons:{primary:'ui-icon-flag'}}
							,click: function(editedDocument, editor){
								gpsInsertPositionInDocument(editedDocument, editor);
								return false;
							}
						};
					};
					if( cameraIsAvailable() ) {
						editorOptions.buttonPhoto = {
							buttonClass: 'photo'
							,label: 'Photo'
							,before: 'cancel'
							,options: {icons:{primary:'ui-icon-image'}}
							,click: function(editedDocument, editor){
								cameraInsertImageDataInDocument(editedDocument, editor);
								return false;
							}
						};
					};
					couchEditor = new $n2.CouchEditor.Editor(editorOptions);
					
					setUpMenu();
				};
					
				function setUpMenu() {

					var $menu = $('#menu');
					
					$menu.html('<input id="searchText" type="text"/>'
							+'<button id="searchButton">Search</button>'
							+'<button id="listAllButton">List All Documents</button>'
							+'<button id="addDocumentButton">New Document</button>');
					
					$menu.find('#searchButton')
						.button({icons:{primary:'ui-icon-search'}})
						.click(performSearch);

					$menu.find('#addDocumentButton')
						.button({icons:{primary:'ui-icon-plusthick'}})
						.click(addDocument);
					
					$menu.find('#listAllButton')
						.button({icons:{primary:'ui-icon-script'}})
						.click(listAllDocuments);
					
					$('#addPic').click(function(){

						$('#cam_logs').remove();
						var $logs = $('<div id="cam_logs"></div>');
						$('#requests').before($logs);

						if( typeof(imports) === 'undefined' ) {
							$logs.append('<div>imports is not defined</div>');
							return;
						} else if( typeof(imports.takePhoto) === 'undefined' ) {
							$logs.append('<div>imports.takePhoto is not defined</div>');
							return;
						} else {
							$logs.append('<div>calling imports.takePhoto</div>');
							imports.takePhoto(
								function(imageData){
									alert("photo received: "+imageData.substr(0,40));
									
									$('#requests').append('<div><img id="cameraImage" src=""/></div>');
	
									var src = 'data:' + imageData.mimeType + ';base64,' + imageData.data;
									document.getElementById("cameraImage").src = src;
								}
								,function(errMessage){
									alert('Error taking picture: '+errMessage);
								}
							);
						};
						return;

						var phoneGapNav = null;
						if( typeof(imports) === 'undefined' ) {
							$logs.append('<div>imports is not defined</div>');
						} else if( typeof(imports.navigator) === 'undefined' ) {
							$logs.append('<div>imports.navigator is not defined</div>');
						} else {
							phoneGapNav = imports.navigator;
						};
						if( null == phoneGapNav ) {
							if( typeof(navigator) === 'undefined' ) {
								$logs.append('<div>navigator is not defined</div>');
							} else {
								phoneGapNav = navigator;
							};
						};
						if( null == phoneGapNav ) {
							return;
						};

						var phoneGapWin = null;
						if( typeof(imports) === 'undefined' ) {
							$logs.append('<div>imports is not defined</div>');
						} else if( typeof(imports.window) === 'undefined' ) {
							$logs.append('<div>imports.window is not defined</div>');
						} else {
							phoneGapWin = imports.window;
						};
						if( null == phoneGapWin ) {
							if( typeof(window) === 'undefined' ) {
								$logs.append('<div>window is not defined</div>');
							} else {
								phoneGapWin = window;
							};
						};
						if( null == phoneGapWin ) {
							return;
						};
						
						if( !phoneGapNav.camera ) {
							$logs.append('<div>phoneGapNav.camera is not defined</div>');
							return;
						};
						if( !phoneGapNav.camera.getPicture ) {
							$logs.append('<div>phoneGapNav.camera.getPicture is not defined</div>');
							return;
						};
						if( !imports.FileUploadOptions ) {
							$logs.append('<div>imports.FileUploadOptions is not defined</div>');
							return;
						};
						if( !imports.FileTransfer ) {
							$logs.append('<div>imports.FileTransfer is not defined</div>');
							return;
						};

						$logs.append('<div>getPicture...</div>');
						phoneGapNav.camera.getPicture(
							uploadPhoto
							,function(message) { 
								$logs.append('<div>failure in getPicture: '+message+'</div>');
								alert('get picture failed: '+message); 
							}
							,{ 
								quality: 50 
								,destinationType: phoneGapNav.camera.DestinationType.FILE_URI
								,sourceType: phoneGapNav.camera.PictureSourceType.PHOTOLIBRARY
							}
						);
						
						function uploadPhoto(imageURI) {
							$logs.append('<div>in upload photo: '+imageURI+'</div>');
							var options = new imports.FileUploadOptions();
							options.fileKey="file";
							options.fileName=imageURI.substr(imageURI.lastIndexOf('/')+1);
							options.mimeType="image/jpeg";
							
							$logs.append('<div>setting parameters</div>');
							var params = new Object();
							params.rev = "test";
							
							options.params = params;
							
							$logs.append('<div>creating FileTransfer</div>');
							var ft = new imports.FileTransfer();
							ft.upload(imageURI, "../../_design/mobile/pictest.jpg", onSuccess, onError, options);
						};
						
						function onSuccess(r) {
							$logs.append('<div>ft success</div>');
							console.log("Code = " + r.responseCode);
				            console.log("Response = " + r.response);
				            console.log("Sent = " + r.bytesSent);
						};
						
						function onError(error) {
							$logs.append('<div>ft error</div>');
							alert("An error has occurred: Code = " + error.code);
						};
					});
					
					if( DEBUGGING ) {
						var $debugBtn = $('<button id="debugButton">Debug</button>');
						$menu.append( $debugBtn );
						$debugBtn
							.button({icons:{primary:'ui-icon-lightbulb'}})
							.click(showDebugging);
					};
				};
			};

			jQuery().ready(function() {
				runConfiguration({}, main_init, function(msg){
					$('#requests').append('<div>'+msg+'</div>');
				});
			});
			// -->
		</script>
	</body>
</html>
